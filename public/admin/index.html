<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadore Clinic | Painel Administrativo</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='18' y='78' font-size='80' font-family='Cormorant Garamond, serif' fill='%23C4A265' font-weight='700'>C</text></svg>">
  
  <style>
    :root {
      --primary: #722F37;
      --primary-dark: #5A1A22;
      --primary-light: #8B3A44;
      --secondary: #1A1A1A;
      --black: #0D0D0D;
      --nude: #E8D5C4;
      --nude-light: #F5EDE4;
      --offwhite: #FAF8F5;
      --gray-light: #E5E5E5;
      --gray: #9E9E9E;
      --gray-dark: #555;
      --gold: #C4A265;
      --white: #fff;
      --success: #4CAF50;
      --error: #D32F2F;
      --warning: #FF9800;
      --info: #2196F3;
      --sidebar-width: 260px;
      --font-heading: 'Cormorant Garamond', serif;
      --font-body: 'Montserrat', sans-serif;
      --shadow: 0 2px 12px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:var(--font-body); background:var(--offwhite); color:var(--secondary); min-height:100vh; }

    /* ---- Login ---- */
    .login-page { display:flex; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(135deg, var(--primary-dark), var(--black)); }
    .login-card { background:var(--white); padding:3rem; border-radius:12px; width:380px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
    .login-card h1 { font-family:var(--font-heading); font-size:2rem; text-align:center; margin-bottom:0.3rem; color:var(--primary); }
    .login-card .subtitle { text-align:center; font-size:0.75rem; letter-spacing:0.2em; text-transform:uppercase; color:var(--gray); margin-bottom:2rem; }
    .login-card .form-group { margin-bottom:1.2rem; }
    .login-card label { display:block; font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--gray-dark); margin-bottom:0.4rem; }
    .login-card input { width:100%; padding:0.8rem 1rem; border:1.5px solid var(--gray-light); border-radius:6px; font-family:var(--font-body); font-size:0.9rem; transition:var(--transition); }
    .login-card input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(114,47,55,0.1); }
    .login-card button { width:100%; padding:0.9rem; background:var(--primary); color:var(--white); border:none; border-radius:6px; font-family:var(--font-body); font-size:0.85rem; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:var(--transition); margin-top:0.5rem; }
    .login-card button:hover { background:var(--primary-dark); }
    .login-error { color:var(--error); font-size:0.8rem; text-align:center; margin-top:1rem; display:none; }

    /* ---- Dashboard Layout ---- */
    .dashboard { display:none; }
    .dashboard.active { display:flex; }

    .sidebar { width:var(--sidebar-width); background:var(--secondary); color:var(--white); min-height:100vh; position:fixed; left:0; top:0; z-index:100; transition:var(--transition); display:flex; flex-direction:column; }
    .sidebar-logo { padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.08); }
    .sidebar-logo h2 { font-family:var(--font-heading); font-size:1.4rem; font-weight:500; }
    .sidebar-logo span { font-size:0.6rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gold); display:block; font-family:var(--font-body); }

    .sidebar-nav { padding:1rem 0; flex:1; }
    .sidebar-nav-item { display:flex; align-items:center; gap:0.8rem; padding:0.85rem 1.5rem; font-size:0.82rem; font-weight:500; color:rgba(255,255,255,0.6); cursor:pointer; transition:var(--transition); letter-spacing:0.04em; border-left:3px solid transparent; }
    .sidebar-nav-item:hover { color:var(--white); background:rgba(255,255,255,0.05); }
    .sidebar-nav-item.active { color:var(--white); background:rgba(255,255,255,0.08); border-left-color:var(--gold); }
    .sidebar-nav-item svg { width:18px; height:18px; opacity:0.7; flex-shrink:0; }
    .sidebar-nav-item .badge { margin-left:auto; background:var(--primary); color:var(--white); padding:2px 8px; border-radius:10px; font-size:0.7rem; font-weight:600; }

    .sidebar-footer { padding:1rem 1.5rem; border-top:1px solid rgba(255,255,255,0.08); }
    .sidebar-footer .user-name { font-size:0.85rem; font-weight:500; }
    .sidebar-footer .user-role { font-size:0.7rem; color:var(--gold); letter-spacing:0.1em; text-transform:uppercase; }
    .sidebar-footer button { margin-top:0.8rem; width:100%; padding:0.5rem; background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.6); border:none; border-radius:4px; font-family:var(--font-body); font-size:0.75rem; cursor:pointer; transition:var(--transition); }
    .sidebar-footer button:hover { background:rgba(255,255,255,0.15); color:var(--white); }

    .main-content { margin-left:var(--sidebar-width); flex:1; min-height:100vh; }
    .main-header { background:var(--white); padding:1.2rem 2rem; display:flex; align-items:center; justify-content:space-between; box-shadow:var(--shadow); position:sticky; top:0; z-index:50; }
    .main-header h1 { font-family:var(--font-heading); font-size:1.6rem; font-weight:500; }
    .main-header .header-actions { display:flex; gap:0.8rem; align-items:center; }
    .main-body { padding:2rem; }

    /* ---- Dashboard Cards ---- */
    .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1.5rem; margin-bottom:2rem; }
    .stat-card { background:var(--white); border-radius:10px; padding:1.5rem; box-shadow:var(--shadow); position:relative; overflow:hidden; }
    .stat-card::after { content:''; position:absolute; top:0; left:0; width:4px; height:100%; }
    .stat-card:nth-child(1)::after { background:var(--primary); }
    .stat-card:nth-child(2)::after { background:var(--gold); }
    .stat-card:nth-child(3)::after { background:var(--success); }
    .stat-card:nth-child(4)::after { background:var(--info); }
    .stat-card .stat-number { font-family:var(--font-heading); font-size:2.5rem; font-weight:600; line-height:1; }
    .stat-card .stat-label { font-size:0.75rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--gray); margin-top:0.4rem; font-weight:500; }

    /* ---- Data Table ---- */
    .panel { background:var(--white); border-radius:10px; box-shadow:var(--shadow); margin-bottom:1.5rem; overflow:hidden; }
    .panel-header { padding:1.2rem 1.5rem; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--gray-light); }
    .panel-header h3 { font-family:var(--font-heading); font-size:1.3rem; font-weight:500; }
    .panel-body { padding:1.5rem; }

    .data-table { width:100%; border-collapse:collapse; }
    .data-table th { text-align:left; font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.1em; color:var(--gray); padding:0.7rem 0.8rem; border-bottom:2px solid var(--gray-light); }
    .data-table td { padding:0.8rem; border-bottom:1px solid var(--gray-light); font-size:0.88rem; vertical-align:middle; }
    .data-table tr:hover { background:var(--offwhite); }
    .data-table tr:last-child td { border-bottom:none; }

    /* admin: show country code instead of emoji */
    .admin-country-code { font-family: Arial, sans-serif; font-weight:700; font-size:0.95rem; margin-right:0.5rem; display:inline-block; }


    .status-badge { display:inline-block; padding:3px 10px; border-radius:12px; font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; }
    .status-confirmed { background:#E8F5E9; color:#2E7D32; }
    .status-cancelled { background:#FFEBEE; color:#C62828; }
    .status-completed { background:#E3F2FD; color:#1565C0; }
    .status-pending { background:#FFF8E1; color:#F57F17; }

    /* ---- Buttons ---- */
    .btn { display:inline-flex; align-items:center; gap:0.4rem; padding:0.5rem 1rem; font-family:var(--font-body); font-size:0.78rem; font-weight:500; letter-spacing:0.05em; border:none; border-radius:6px; cursor:pointer; transition:var(--transition); text-transform:uppercase; }
    .btn-primary { background:var(--primary); color:var(--white); }
    .btn-primary:hover { background:var(--primary-dark); }
    .btn-outline { background:transparent; color:var(--primary); border:1.5px solid var(--primary); }
    .btn-outline:hover { background:var(--primary); color:var(--white); }
    .btn-success { background:var(--success); color:var(--white); }
    .btn-danger { background:var(--error); color:var(--white); }
    .btn-danger:hover { background:#B71C1C; }
    .btn-sm { padding:0.35rem 0.7rem; font-size:0.72rem; }
    .btn-gold { background:var(--gold); color:var(--white); }
    .btn-gold:hover { opacity:0.9; }

    /* ---- Forms ---- */
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .form-group { margin-bottom:1rem; }
    .form-group label { display:block; font-size:0.72rem; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--gray-dark); margin-bottom:0.3rem; }
    .form-group input, .form-group select, .form-group textarea { width:100%; padding:0.7rem 0.8rem; border:1.5px solid var(--gray-light); border-radius:6px; font-family:var(--font-body); font-size:0.88rem; transition:var(--transition); background:var(--white); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline:none; border-color:var(--primary); }
    .form-group textarea { min-height:60px; resize:vertical; }

    /* ---- Page sections ---- */
    .page-section { display:none; }
    .page-section.active { display:block; animation:fadeIn 0.3s ease; }

    .empty-state { text-align:center; padding:3rem; color:var(--gray); }
    .empty-state svg { width:48px; height:48px; margin-bottom:1rem; opacity:0.4; }
    .empty-state p { font-size:0.9rem; }

    /* ---- Filter Bar ---- */
    .filter-bar { display:flex; gap:1rem; margin-bottom:1.5rem; flex-wrap:wrap; align-items:center; }
    .filter-bar input, .filter-bar select { padding:0.6rem 0.8rem; border:1.5px solid var(--gray-light); border-radius:6px; font-family:var(--font-body); font-size:0.85rem; }
    .filter-bar input:focus, .filter-bar select:focus { outline:none; border-color:var(--primary); }

    /* ---- Flag Select ---- */
    .country-option { font-size:1rem; }

    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

    /* ---- Toast ---- */
    .admin-toast { position:fixed; top:20px; right:20px; padding:0.8rem 1.2rem; border-radius:8px; color:var(--white); font-size:0.85rem; z-index:9999; animation:slideIn 0.3s ease; box-shadow:0 4px 15px rgba(0,0,0,0.2); }
    .admin-toast.success { background:var(--success); }
    .admin-toast.error { background:var(--error); }

    /* modal for viewing appointment notes */
    .admin-modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:10000; padding:24px; }
    .admin-modal { background:var(--white); width:min(1000px,96%); max-width:1100px; border-radius:12px; box-shadow:0 18px 50px rgba(0,0,0,0.18); padding:1.25rem; }
    .admin-modal h4 { margin:0 0 0.5rem; font-family:var(--font-heading); }
    .admin-modal .modal-body { max-height:70vh; overflow:auto; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; color:var(--secondary); line-height:1.6; }
    .admin-modal .modal-actions { text-align:right; margin-top:1rem; }
    .admin-modal .modal-actions .btn { min-width:90px; }

    @keyframes slideIn { from{opacity:0;transform:translateX(100px)} to{opacity:1;transform:translateX(0)} }

    /* ---- Responsive ---- */
    @media(max-width:1024px) { .stats-grid{grid-template-columns:repeat(2,1fr)} .form-row{grid-template-columns:1fr} }
    @media(max-width:768px) {
      .sidebar { transform:translateX(-100%); }
      .sidebar.open { transform:translateX(0); }
      .main-content { margin-left:0; }
      .stats-grid { grid-template-columns:1fr; }
      .data-table { font-size:0.8rem; }
      .main-header .mobile-menu-btn { display:flex; }
    }

    .mobile-menu-btn { display:none; background:none; border:none; cursor:pointer; padding:0.5rem; }
    @media(max-width:768px) { .mobile-menu-btn{display:flex;flex-direction:column;gap:4px} .mobile-menu-btn span{width:22px;height:2px;background:var(--secondary)} }

    /* Scrollbar */
    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:var(--offwhite); }
    ::-webkit-scrollbar-thumb { background:var(--gray); border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:var(--gray-dark); }
  </style>
</head>
<body>

  <!-- ========== LOGIN ========== -->
  <div class="login-page" id="loginPage">
    <div class="login-card">
      <h1>Cadore</h1>
      <p class="subtitle">Painel Administrativo</p>
      <form id="loginForm">
        <div class="form-group">
          <label>Usu√°rio</label>
          <input type="text" id="loginUsername" placeholder="admin" autocomplete="username" required>
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" required>
        </div>
        <button type="submit">Entrar</button>
      </form>
      <p class="login-error" id="loginError"></p>
    </div>
  </div>

  <!-- ========== DASHBOARD ========== -->
  <div class="dashboard" id="dashboard">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <h2>Cadore</h2>
        <span>Clinic Admin</span>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-nav-item active" data-page="overview" onclick="showPage('overview', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Vis√£o Geral
        </div>
        <div class="sidebar-nav-item" data-page="appointments" onclick="showPage('appointments', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Agendamentos
          <span class="badge" id="badgeAppointments" style="display:none">0</span>
        </div>
        <div class="sidebar-nav-item" data-page="blocked" onclick="showPage('blocked', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
          Bloqueios
        </div>
        <div class="sidebar-nav-item" data-page="international" onclick="showPage('international', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Agenda Internacional
        </div>
        <div class="sidebar-nav-item" data-page="services" onclick="showPage('services', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          Servi√ßos
        </div>
        <div class="sidebar-nav-item" data-page="location" onclick="showPage('location', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1118 0z"/><circle cx="12" cy="10" r="2"/></svg>
          Localiza√ß√£o
        </div>
        <div class="sidebar-nav-item" data-page="messages" onclick="showPage('messages', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Mensagens
          <span class="badge" id="badgeMessages" style="display:none">0</span>
        </div>
      </nav>
      <div class="sidebar-footer">
        <div class="user-name" id="adminName">Admin</div>
        <div class="user-role">Administradora</div>
        <button onclick="logout()">Sair</button>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <header class="main-header">
        <div style="display:flex;align-items:center;gap:1rem">
          <button class="mobile-menu-btn" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
          <h1 id="pageTitle">Vis√£o Geral</h1>
        </div>
        <div class="header-actions">
          <a href="/" class="btn btn-outline btn-sm">Ver Site</a>
        </div>
      </header>

      <div class="main-body">
        <!-- ===== Overview ===== -->
        <div class="page-section active" id="pageOverview">
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="stat-number" id="statToday">0</div><div class="stat-label">Hoje</div></div>
            <div class="stat-card"><div class="stat-number" id="statUpcoming">0</div><div class="stat-label">Pr√≥ximos</div></div>
            <div class="stat-card"><div class="stat-number" id="statTotal">0</div><div class="stat-label">Total</div></div>
            <div class="stat-card"><div class="stat-number" id="statMessages">0</div><div class="stat-label">Mensagens</div></div>
          </div>
          <div class="panel">
            <div class="panel-header"><h3>Pr√≥ximos Agendamentos</h3></div>
            <div class="panel-body" id="recentAppointments"><div class="empty-state"><p>Carregando...</p></div></div>
          </div>
        </div>

        <!-- ===== Appointments ===== -->
        <div class="page-section" id="pageAppointments">
          <div class="filter-bar">
            <input type="date" id="filterDate" onchange="loadAppointments()">
            <select id="filterStatus" onchange="loadAppointments()">
              <option value="">Todos os status</option>
              <option value="confirmed">Confirmados</option>
              <option value="cancelled">Cancelados</option>
              <option value="completed">Conclu√≠dos</option>
            </select>
            <button class="btn btn-gold" onclick="exportAppointments()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Exportar CSV
            </button>
          </div>
          <div class="panel">
            <div class="panel-body">
              <table class="data-table">
                <thead>
                  <tr><th>Cliente</th><th>Telefone</th><th>Servi√ßo</th><th>Data</th><th>Hor√°rio</th><th>Status</th><th>Observa√ß√µes</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="appointmentsTableBody">
                  <tr><td colspan="8" style="text-align:center;color:var(--gray)">Carregando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===== Blocked Times ===== -->
        <div class="page-section" id="pageBlocked">
          <div class="panel">
            <div class="panel-header">
              <h3>Bloquear Hor√°rio</h3>
            </div>
            <div class="panel-body">
              <form id="blockForm" onsubmit="addBlockedTime(event)">
                <div class="form-row">
                  <div class="form-group">
                    <label>Data *</label>
                    <input type="date" id="blockDate" required>
                  </div>
                  <div class="form-group">
                    <label>Hor√°rio (deixe vazio para dia inteiro)</label>
                    <input type="time" id="blockTime">
                  </div>
                </div>
                <div class="form-group">
                  <label>
                    <input type="checkbox" id="blockAllDay" onchange="document.getElementById('blockTime').disabled = this.checked">
                    Bloquear dia inteiro
                  </label>
                </div>
                <div class="form-group">
                  <label>Motivo</label>
                  <input type="text" id="blockReason" placeholder="Motivo do bloqueio (opcional)">
                </div>
                <button type="submit" class="btn btn-primary">Bloquear</button>
              </form>
            </div>
          </div>
          <div class="panel" style="margin-top:1.5rem">
            <div class="panel-header"><h3>Hor√°rios Bloqueados</h3></div>
            <div class="panel-body">
              <table class="data-table">
                <thead><tr><th>Data</th><th>Hor√°rio</th><th>Motivo</th><th>A√ß√µes</th></tr></thead>
                <tbody id="blockedTableBody"><tr><td colspan="4" style="text-align:center;color:var(--gray)">Carregando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===== International Dates ===== -->
        <div class="page-section" id="pageInternational">
          <div class="panel">
            <div class="panel-header"><h3>Adicionar Viagem Internacional</h3></div>
            <div class="panel-body">
              <form id="intlForm" onsubmit="addInternationalDate(event)">
                <div class="form-row">
                  <div class="form-group">
                    <label>Pa√≠s *</label>
                    <select id="intlCountry" required onchange="updateIntlFlag()">
                      <option value="">Selecione...</option>
                      <option value="BR|Brasil|üáßüá∑">üáßüá∑ Brasil</option>
                      <option value="NL|Holanda|üá≥üá±">üá≥üá± Holanda</option>
                      <option value="PT|Portugal|üáµüáπ">üáµüáπ Portugal</option>
                      <option value="ES|Espanha|üá™üá∏">üá™üá∏ Espanha</option>
                      <option value="FR|Fran√ßa|üá´üá∑">üá´üá∑ Fran√ßa</option>
                      <option value="IT|It√°lia|üáÆüáπ">üáÆüáπ It√°lia</option>
                      <option value="DE|Alemanha|üá©üá™">üá©üá™ Alemanha</option>
                      <option value="US|Estados Unidos|üá∫üá∏">üá∫üá∏ Estados Unidos</option>
                      <option value="GB|Reino Unido|üá¨üáß">üá¨üáß Reino Unido</option>
                      <option value="BE|B√©lgica|üáßüá™">üáßüá™ B√©lgica</option>
                      <option value="CH|Su√≠√ßa|üá®üá≠">üá®üá≠ Su√≠√ßa</option>
                      <option value="JP|Jap√£o|üáØüáµ">üáØüáµ Jap√£o</option>
                      <option value="AE|Emirados √Årabes|üá¶üá™">üá¶üá™ Emirados √Årabes</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Cidade</label>
                    <input type="text" id="intlCity" placeholder="Ex: Amsterd√£">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Data in√≠cio *</label>
                    <input type="date" id="intlStart" required>
                  </div>
                  <div class="form-group">
                    <label>Data fim *</label>
                    <input type="date" id="intlEnd" required>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Adicionar</button>
              </form>
            </div>
          </div>
          <div class="panel" style="margin-top:1.5rem">
            <div class="panel-header"><h3>Datas Internacionais</h3></div>
            <div class="panel-body">
              <table class="data-table">
                <thead><tr><th>Pa√≠s</th><th>Cidade</th><th>Per√≠odo</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="intlTableBody"><tr><td colspan="5" style="text-align:center;color:var(--gray)">Carregando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===== Localiza√ß√£o (Mapa) ===== -->
        <div class="page-section" id="pageLocation">
          <div class="panel">
            <div class="panel-header"><h3>Localiza√ß√£o do Site</h3></div>
            <div class="panel-body">
              <form id="mapForm" onsubmit="saveMapSettings(event)">
                <div class="form-group">
                  <label>Pesquisar por endere√ßo</label>
                  <div style="display:flex;gap:0.5rem;align-items:center">
                    <input type="search" id="mapSearch" placeholder="Digite um endere√ßo (ex: Setor Bueno, Goi√¢nia)" class="form-input" style="flex:1">
                    <button type="button" class="btn btn-outline" id="mapSearchBtn" onclick="performGeocodeSearch()">Buscar</button>
                  </div>
                  <div id="mapSearchResults" style="margin-top:0.5rem;border:1px solid #eee;background:#fff;border-radius:6px;max-height:200px;overflow:auto;display:none;box-shadow:0 6px 18px rgba(0,0,0,0.06);"></div>
                </div>

                <div class="form-group">
                  <label>Endere√ßo / R√≥tulo</label>
                  <input type="text" id="mapLabel" placeholder="Ex: Setor Bueno ‚Äî Goi√¢nia" class="form-input">
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Latitude</label>
                    <input type="number" step="0.000001" id="mapLat" class="form-input" required>
                  </div>
                  <div class="form-group">
                    <label>Longitude</label>
                    <input type="number" step="0.000001" id="mapLng" class="form-input" required>
                  </div>
                </div>
                <div class="form-group">
                  <label>Zoom</label>
                  <input type="number" id="mapZoom" class="form-input" min="1" max="20" value="13">
                </div>
                <button class="btn btn-primary" type="submit">Salvar Localiza√ß√£o</button>
              </form>

              <div style="margin-top:1rem">
                <iframe id="mapPreview" style="width:100%;height:300px;border:0;margin-top:0.5rem" src=""></iframe>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== Services ===== -->
        <div class="page-section" id="pageServices">
          <div class="panel">
            <div class="panel-header"><h3>Adicionar Servi√ßo</h3></div>
            <div class="panel-body">
              <form id="serviceForm" onsubmit="addService(event)">
                <input type="hidden" id="svcId" value="">
                <div class="form-row">
                  <div class="form-group"><label>Nome *</label><input type="text" id="svcName" required placeholder="Nome do servi√ßo"></div>
                  <div class="form-group" style="display:flex;gap:0.75rem;align-items:center">
                    <div style="flex:1">
                      <label>√çcone</label>
                      <select id="svcIcon" class="form-input">
                        <option value="treatment">Padr√£o</option>
                        <option value="tattoo">Tatuagem</option>
                        <option value="lash">Lash Lifting</option>
                        <option value="brow">Brow Lamination</option>
                        <option value="micro">Micropigmenta√ß√£o</option>
                        <option value="lip">L√°bios</option>
                        <option value="nail">Unhas</option>
                        <option value="pedicure">Pedicure</option>
                        <option value="spa">Spa / Massagem</option>
                        <option value="laser">Laser</option>
                        <option value="wax">Depila√ß√£o / Cera</option>
                        <option value="brush">Maquiagem</option>
                        <option value="scissors">Modelagem / Tesoura</option>
                        <option value="bottle">Skincare</option>
                        <option value="mask">Tratamento Facial</option>
                        <option value="sparkle">Est√©tica</option>
                        <option value="syringe">Preenchimento</option>
                        <option value="dropper">S√©rum / Ampola</option>
                        <option value="leaf">Bem‚Äëestar</option>
                        <option value="heart">Favorito</option>
                        <option value="peel">Peeling</option>
                      </select>
                    </div>
                    <div id="svcIconPreview" aria-hidden="true" title="Preview do √≠cone" style="width:56px;height:56px;border-radius:8px;background:rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:center"></div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group"><label>Dura√ß√£o (min)</label><input type="number" id="svcDuration" value="60" min="15" step="15"></div>
                </div>
                <div class="form-group"><label>Descri√ß√£o</label><textarea id="svcDescription" placeholder="Descri√ß√£o do servi√ßo..."></textarea></div>
                <div style="display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem">
                  <button type="submit" id="svcSubmitBtn" class="btn btn-primary">Adicionar Servi√ßo</button>
                  <button type="button" id="svcCancelBtn" class="btn btn-outline" style="display:none" onclick="resetServiceForm()">Cancelar</button>
                </div>
              </form>
            </div>
          </div>
          <div class="panel" style="margin-top:1.5rem">
            <div class="panel-header"><h3>Servi√ßos Cadastrados</h3></div>
            <div class="panel-body">
              <table class="data-table">
                <thead><tr><th>Nome</th><th>√çcone</th><th>Dura√ß√£o</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                <tbody id="servicesTableBody"><tr><td colspan="4" style="text-align:center;color:var(--gray)">Carregando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===== Messages ===== -->
        <div class="page-section" id="pageMessages">
          <div class="panel">
            <div class="panel-header"><h3>Mensagens de Contato</h3></div>
            <div class="panel-body">
              <table class="data-table">
                <thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Mensagem</th><th>Data</th><th>Status</th></tr></thead>
                <tbody id="messagesTableBody"><tr><td colspan="6" style="text-align:center;color:var(--gray)">Carregando...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== STATE ==========
    let sessionId = localStorage.getItem('cadore_session');
    const API = '/api/admin';
    const pageTitles = {
      overview: 'Vis√£o Geral',
      appointments: 'Agendamentos',
      blocked: 'Bloqueios de Hor√°rio',
      international: 'Agenda Internacional',
      services: 'Servi√ßos',
      messages: 'Mensagens'
    };

    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      if (sessionId) checkSession();
      document.getElementById('loginForm').addEventListener('submit', login);
    });

    // ========== AUTH ==========
    async function login(e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      try {
        const res = await fetch(`${API}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok) {
          sessionId = data.sessionId;
          localStorage.setItem('cadore_session', sessionId);
          document.getElementById('adminName').textContent = data.name;
          showDashboard();
        } else {
          errorEl.textContent = data.error || 'Erro no login';
          errorEl.style.display = 'block';
        }
      } catch (err) {
        errorEl.textContent = 'Erro de conex√£o';
        errorEl.style.display = 'block';
      }
    }

    async function checkSession() {
      try {
        const res = await fetch(`${API}/me`, { headers: { 'x-session-id': sessionId } });
        if (res.ok) {
          const user = await res.json();
          document.getElementById('adminName').textContent = user.name;
          showDashboard();
        } else {
          localStorage.removeItem('cadore_session');
          sessionId = null;
        }
      } catch (err) {
        localStorage.removeItem('cadore_session');
        sessionId = null;
      }
    }

    function logout() {
      fetch(`${API}/logout`, { method: 'POST', headers: { 'x-session-id': sessionId } });
      localStorage.removeItem('cadore_session');
      sessionId = null;
      document.getElementById('dashboard').classList.remove('active');
      document.getElementById('loginPage').style.display = 'flex';
    }

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').classList.add('active');
      loadStats();
      loadAppointments();
      loadRecentAppointments();
    }

    function apiHeaders() {
      return { 'Content-Type': 'application/json', 'x-session-id': sessionId };
    }

    // ========== NAVIGATION ==========
    function showPage(page, el) {
      document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
      document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
      document.querySelectorAll('.sidebar-nav-item').forEach(i => i.classList.remove('active'));
      if (el) el.classList.add('active');
      document.getElementById('pageTitle').textContent = pageTitles[page] || '';

      // Load data for page
      if (page === 'overview') { loadStats(); loadRecentAppointments(); }
      if (page === 'appointments') loadAppointments();
      if (page === 'blocked') loadBlockedTimes();
      if (page === 'international') loadIntlDates();
      if (page === 'location') loadMapSettings();
      if (page === 'services') loadServices();
      if (page === 'messages') loadMessages();

      // Close sidebar on mobile
      document.getElementById('sidebar').classList.remove('open');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // ========== STATS ==========
    async function loadStats() {
      try {
        const res = await fetch(`${API}/stats`, { headers: apiHeaders() });
        const s = await res.json();
        document.getElementById('statToday').textContent = s.todayCount;
        document.getElementById('statUpcoming').textContent = s.upcomingCount;
        document.getElementById('statTotal').textContent = s.totalCount;
        document.getElementById('statMessages').textContent = s.unreadMessages;

        // update badge for appointments (hide when zero)
        const badgeA = document.getElementById('badgeAppointments');
        if (badgeA) {
          badgeA.textContent = s.upcomingCount > 0 ? String(s.upcomingCount) : '';
          badgeA.style.display = s.upcomingCount > 0 ? 'inline' : 'none';
        }

        // update badge for messages (hide when zero)
        const badgeM = document.getElementById('badgeMessages');
        if (badgeM) {
          badgeM.textContent = s.unreadMessages > 0 ? String(s.unreadMessages) : '';
          badgeM.style.display = s.unreadMessages > 0 ? 'inline' : 'none';
        }
      } catch (err) { console.error(err); }
    }

    // ========== APPOINTMENTS ==========
    async function loadAppointments() {
      try {
        const date = document.getElementById('filterDate').value;
        const status = document.getElementById('filterStatus').value;
        let url = `${API}/appointments?`;
        if (date) url += `date=${date}&`;
        if (status) url += `status=${status}&`;

        const res = await fetch(url, { headers: apiHeaders() });
        const data = await res.json();

        const tbody = document.getElementById('appointmentsTableBody');
        if (data.appointments.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:2rem">Nenhum agendamento encontrado</td></tr>';
          return;
        }

        // keep a copy so we don't have to inline potentially unsafe strings into attributes
        window.adminAppointments = data.appointments;

        tbody.innerHTML = data.appointments.map(a => `
          <tr>
            <td><strong>${a.client_name}</strong></td>
            <td>${a.client_phone}</td>
            <td>${a.service_name}</td>
            <td>${formatDate(a.appointment_date)}</td>
            <td>${a.appointment_time}</td>
            <td><span class="status-badge status-${a.status}">${statusLabel(a.status)}</span></td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.notes ? (a.notes.length > 60 ? a.notes.slice(0,60) + '‚Ä¶' : a.notes) : '-'}</td>
            <td>
              ${a.status === 'confirmed' ? `
                <button class="btn btn-success btn-sm" onclick="updateStatus(${a.id},'completed')">‚úì</button>
                <button class="btn btn-danger btn-sm" onclick="updateStatus(${a.id},'cancelled')">‚úï</button>
              ` : ''}
              ${a.notes ? `<button class="btn btn-sm" onclick="viewNoteById(${a.id})" title="Ver observa√ß√£o">Ver</button>` : ''}
              <button class="btn btn-sm btn-outline" onclick="deleteAppointment(${a.id})" title="Excluir">üóë</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error(err); }
    }

    async function loadRecentAppointments() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`${API}/appointments?status=confirmed&limit=5`, { headers: apiHeaders() });
        const data = await res.json();
        const container = document.getElementById('recentAppointments');

        if (data.appointments.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>Nenhum agendamento pr√≥ximo</p></div>';
          return;
        }

        container.innerHTML = `<table class="data-table"><thead><tr><th>Cliente</th><th>Servi√ßo</th><th>Data</th><th>Hor√°rio</th><th>Status</th></tr></thead><tbody>
          ${data.appointments.slice(0, 5).map(a => `
            <tr>
              <td><strong>${a.client_name}</strong></td>
              <td>${a.service_name}</td>
              <td>${formatDate(a.appointment_date)}</td>
              <td>${a.appointment_time}</td>
              <td><span class="status-badge status-${a.status}">${statusLabel(a.status)}</span></td>
            </tr>
          `).join('')}
        </tbody></table>`;
      } catch (err) { console.error(err); }
    }

    async function updateStatus(id, status) {
      try {
        await fetch(`${API}/appointments/${id}`, {
          method: 'PATCH',
          headers: apiHeaders(),
          body: JSON.stringify({ status })
        });
        showAdminToast('Status atualizado!', 'success');
        loadAppointments();
        loadStats();
      } catch (err) { showAdminToast('Erro ao atualizar', 'error'); }
    }

    async function deleteAppointment(id) {
      if (!confirm('Excluir este agendamento?')) return;
      try {
        await fetch(`${API}/appointments/${id}`, { method: 'DELETE', headers: apiHeaders() });
        showAdminToast('Agendamento exclu√≠do', 'success');
        loadAppointments();
        loadStats();
      } catch (err) { showAdminToast('Erro ao excluir', 'error'); }
    }

    async function exportAppointments() {
      const start = document.getElementById('filterDate').value || '';
      window.open(`${API}/export?start_date=${start}&end_date=2099-12-31`, '_blank');
    }

    // ========== BLOCKED TIMES ==========
    async function loadBlockedTimes() {
      try {
        const res = await fetch(`${API}/blocked-times`, { headers: apiHeaders() });
        const blocks = await res.json();
        const tbody = document.getElementById('blockedTableBody');

        if (blocks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--gray)">Nenhum bloqueio</td></tr>';
          return;
        }

        tbody.innerHTML = blocks.map(b => `
          <tr>
            <td>${formatDate(b.block_date)}</td>
            <td>${b.all_day ? 'Dia inteiro' : b.block_time || '-'}</td>
            <td>${b.reason || '-'}</td>
            <td><button class="btn btn-danger btn-sm" onclick="removeBlock(${b.id})">Remover</button></td>
          </tr>
        `).join('');
      } catch (err) { console.error(err); }
    }

    async function addBlockedTime(e) {
      e.preventDefault();
      const block_date = document.getElementById('blockDate').value;
      const block_time = document.getElementById('blockTime').value;
      const all_day = document.getElementById('blockAllDay').checked;
      const reason = document.getElementById('blockReason').value;

      try {
        const res = await fetch(`${API}/blocked-times`, {
          method: 'POST',
          headers: apiHeaders(),
          body: JSON.stringify({ block_date, block_time: all_day ? null : block_time, all_day, reason })
        });
        if (res.ok) {
          showAdminToast('Hor√°rio bloqueado!', 'success');
          document.getElementById('blockForm').reset();
          loadBlockedTimes();
        }
      } catch (err) { showAdminToast('Erro ao bloquear', 'error'); }
    }

    async function removeBlock(id) {
      try {
        await fetch(`${API}/blocked-times/${id}`, { method: 'DELETE', headers: apiHeaders() });
        showAdminToast('Bloqueio removido', 'success');
        loadBlockedTimes();
      } catch (err) { showAdminToast('Erro', 'error'); }
    }

    // ========== INTERNATIONAL DATES ==========
    async function loadIntlDates() {
      try {
        const res = await fetch(`${API}/international-dates`, { headers: apiHeaders() });
        const dates = await res.json();
        const tbody = document.getElementById('intlTableBody');

        if (dates.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray)">Nenhuma viagem cadastrada</td></tr>';
          return;
        }

        tbody.innerHTML = dates.map(d => `
          <tr>
            <td><span class="admin-country-code">${d.country_code}</span> ${d.country_name}</td>
            <td>${d.city || '-'}</td>
            <td>${formatDate(d.start_date)} ‚Äî ${formatDate(d.end_date)}</td>
            <td><span class="status-badge ${d.active ? 'status-confirmed' : 'status-cancelled'}">${d.active ? 'Ativo' : 'Inativo'}</span></td>
            <td>
              <button class="btn btn-sm ${d.active ? 'btn-outline' : 'btn-success'}" onclick="toggleIntl(${d.id}, ${!d.active})">${d.active ? 'Desativar' : 'Ativar'}</button>
              <button class="btn btn-danger btn-sm" onclick="deleteIntl(${d.id})">Excluir</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error(err); }
    }

    async function addInternationalDate(e) {
      e.preventDefault();
      const sel = document.getElementById('intlCountry').value.split('|');
      const city = document.getElementById('intlCity').value;
      const start_date = document.getElementById('intlStart').value;
      const end_date = document.getElementById('intlEnd').value;

      try {
        const res = await fetch(`${API}/international-dates`, {
          method: 'POST',
          headers: apiHeaders(),
          body: JSON.stringify({ country_code: sel[0], country_name: sel[1], flag_emoji: sel[2], start_date, end_date, city })
        });
        if (res.ok) {
          showAdminToast('Viagem adicionada!', 'success');
          document.getElementById('intlForm').reset();
          loadIntlDates();
        }
      } catch (err) { showAdminToast('Erro ao adicionar', 'error'); }
    }

    async function toggleIntl(id, active) {
      try {
        await fetch(`${API}/international-dates/${id}`, { method: 'PATCH', headers: apiHeaders(), body: JSON.stringify({ active }) });
        loadIntlDates();
      } catch (err) { showAdminToast('Erro', 'error'); }
    }

    async function deleteIntl(id) {
      if (!confirm('Excluir esta viagem?')) return;
      try {
        await fetch(`${API}/international-dates/${id}`, { method: 'DELETE', headers: apiHeaders() });
        showAdminToast('Removido', 'success');
        loadIntlDates();
      } catch (err) { showAdminToast('Erro', 'error'); }
    }

    // ========== MAP SETTINGS (Admin) ==========
    async function loadMapSettings() {
      try {
        const res = await fetch(`${API}/map`, { headers: apiHeaders() });
        if (!res.ok) throw new Error('failed');
        const m = await res.json();
        document.getElementById('mapLabel').value = m.label || '';
        document.getElementById('mapLat').value = m.lat || '';
        document.getElementById('mapLng').value = m.lng || '';
        document.getElementById('mapZoom').value = m.zoom || 13;
        updateMapPreview();
      } catch (err) {
        console.error('loadMapSettings', err);
      }
    }

    function updateMapPreview() {
      const lat = document.getElementById('mapLat').value;
      const lng = document.getElementById('mapLng').value;
      const zoom = document.getElementById('mapZoom').value || 13;
      const iframe = document.getElementById('mapPreview');
      if (lat && lng) iframe.src = `https://maps.google.com/maps?q=${lat},${lng}&z=${zoom}&output=embed`;
      else iframe.src = '';
    }

    async function saveMapSettings(e) {
      e.preventDefault();
      try {
        const lat = parseFloat(document.getElementById('mapLat').value);
        const lng = parseFloat(document.getElementById('mapLng').value);
        const label = document.getElementById('mapLabel').value;
        const zoom = parseInt(document.getElementById('mapZoom').value, 10) || 13;
        const res = await fetch(`${API}/map`, {
          method: 'PATCH',
          headers: apiHeaders(),
          body: JSON.stringify({ lat, lng, label, zoom })
        });
        if (res.ok) {
          showAdminToast('Localiza√ß√£o atualizada', 'success');
          loadMapSettings();
        } else {
          const err = await res.json();
          showAdminToast(err.error || 'Erro', 'error');
        }
      } catch (err) {
        showAdminToast('Erro de conex√£o', 'error');
      }
    }

    // ========== GEOCODING (Nominatim) ==========
    let _mapSearchTimer = null;
    async function performGeocodeSearch() {
      const q = document.getElementById('mapSearch').value.trim();
      if (!q) return showGeocodeResults([]);
      try {
        const container = document.getElementById('mapSearchResults');
        container.style.display = 'block';
        container.innerHTML = '<div style="padding:0.75rem;color:#777">Buscando...</div>';
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=6&q=${encodeURIComponent(q)}`);
        const items = await res.json();
        showGeocodeResults(items);
      } catch (err) {
        console.error('geocode', err);
        showGeocodeResults([]);
      }
    }

    function debouncedMapSearch(ev) {
      clearTimeout(_mapSearchTimer);
      const q = ev.target.value.trim();
      const container = document.getElementById('mapSearchResults');
      if (!q) { container.style.display = 'none'; container.innerHTML = ''; return; }
      _mapSearchTimer = setTimeout(() => performGeocodeSearch(), 350);
    }

    function showGeocodeResults(items) {
      const container = document.getElementById('mapSearchResults');
      if (!items || items.length === 0) { container.style.display = 'none'; container.innerHTML = ''; return; }
      container.style.display = 'block';
      container.innerHTML = items.map((it, idx) => `
        <div class="map-search-item" data-idx="${idx}" style="padding:0.6rem 0.75rem;border-bottom:1px solid #f2f2f2;cursor:pointer">
          <div style="font-size:0.9rem">${it.display_name}</div>
          <div style="font-size:0.78rem;color:#888;margin-top:4px">lat: ${parseFloat(it.lat).toFixed(6)} ‚Ä¢ lon: ${parseFloat(it.lon).toFixed(6)}</div>
        </div>
      `).join('');
      Array.from(container.querySelectorAll('.map-search-item')).forEach((el, i) => {
        el.addEventListener('click', () => {
          const item = items[i];
          document.getElementById('mapLabel').value = item.display_name;
          document.getElementById('mapLat').value = parseFloat(item.lat).toFixed(6);
          document.getElementById('mapLng').value = parseFloat(item.lon).toFixed(6);
          container.style.display = 'none';
          updateMapPreview();
        });
      });
    }

    // wire input events for search and preview
    document.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('mapSearch');
      if (s) s.addEventListener('input', debouncedMapSearch);
      const latEl = document.getElementById('mapLat');
      const lngEl = document.getElementById('mapLng');
      const zoomEl = document.getElementById('mapZoom');
      if (latEl) latEl.addEventListener('input', updateMapPreview);
      if (lngEl) lngEl.addEventListener('input', updateMapPreview);
      if (zoomEl) zoomEl.addEventListener('input', updateMapPreview);
    });

    document.addEventListener('click', (e) => {
      const container = document.getElementById('mapSearchResults');
      if (!container) return;
      if (!e.target.closest('#mapSearch') && !e.target.closest('#mapSearchResults')) {
        container.style.display = 'none';
      }
    });

    // ========== SERVICES ==========
    const ADMIN_ICONS = {
      tattoo: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>`,
      lash: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
      brow: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2"/><path d="M2 12c1-3 4-6 10-6s9 3 10 6"/></svg>`,
      micro: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="m16 2-4 4-4-4"/><path d="M12 6v6"/><circle cx="12" cy="17" r="5"/></svg>`,
      treatment: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`,
      lip: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/><path d="M7 13c1.5 2 4.5 2 6 0"/></svg>`,
      nail: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 21v-6a3 3 0 013-3h4a3 3 0 013 3v6"/><path d="M12 7V3"/></svg>`,
      spa: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2s4 3 4 6a4 4 0 01-8 0c0-3 4-6 4-6z"/><path d="M4 20s4-6 8-6 8 6 8 6"/></svg>`,
      laser: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12h18"/><path d="M12 3v18"/><path d="M7 7l10 10"/></svg>`,
      brush: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 22s4-1 6-3 4-4 6-6 3-6 3-6"/><path d="M14 7l3 3"/></svg>`,
      scissors: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><path d="M8.5 8.5L15.5 15.5"/></svg>`,
      bottle: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="2" width="12" height="20" rx="2"/><path d="M9 7h6"/></svg>`,
      mask: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12s3-6 10-6 10 6 10 6v4s-3 6-10 6S2 16 2 16v-4z"/><path d="M8 10h.01M16 10h.01"/></svg>`,
      sparkle: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2l1.5 4.5L18 8l-4.5 1.5L12 14l-1.5-4.5L6 8l4.5-1.5L12 2z"/></svg>`,

      syringe: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 3l-3 3-7 7-4 4-3 3 1 1 3-3 4-4 7-7 3-3-1-1z"/><path d="M14 7l3-3"/></svg>`,
      dropper: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 8c0 4-8 12-8 12S4 12 4 8a8 8 0 0116 0z"/><path d="M8 8l8-8"/></svg>`,
      leaf: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 12c4-8 14-8 20 0-6-4-14-4-20 0z"/><path d="M12 2v20"/></svg>`,
      heart: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.8 4.6c-1.5-1.4-3.9-1.4-5.5 0L12 7l-3.3-2.4c-1.6-1.4-4-1.4-5.5 0-1.6 1.5-1.6 4 0 5.5L12 20l8.8-9.9c1.6-1.5 1.6-4 0-5.5z"/></svg>`,
      wax: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2s4 3 4 6c0 3-4 6-4 6s-4-3-4-6c0-3 4-6 4-6z"/><path d="M12 14v6"/></svg>`,
      pedicure: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 21v-2a4 4 0 014-4h6a4 4 0 014 4v2"/><path d="M7 7a2 2 0 100-4 2 2 0 000 4z"/></svg>`,
      peel: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M7 2h10l-3 7v8a2 2 0 01-4 0v-8L7 2z"/></svg>`
    };

    async function loadServices() {
      try {
        const res = await fetch(`${API}/services`, { headers: apiHeaders() });
        const services = await res.json();
        const tbody = document.getElementById('servicesTableBody');

        if (services.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray)">Nenhum servi√ßo</td></tr>';
          return;
        }

        // keep a local copy for edit actions
        window.adminServices = services;

        tbody.innerHTML = services.map(s => `
          <tr>
            <td><strong>${s.name}</strong><br><small style="color:var(--gray)">${s.description || ''}</small></td>
            <td>${ADMIN_ICONS[s.icon] || ADMIN_ICONS[s.name] || ADMIN_ICONS['treatment']}</td>
            <td>${s.duration} min</td>
            <td><span class="status-badge ${s.active ? 'status-confirmed' : 'status-cancelled'}">${s.active ? 'Ativo' : 'Inativo'}</span></td>
            <td>
              <button class="btn btn-sm" onclick="editService(${s.id})">Editar</button>
              <button class="btn btn-sm ${s.active ? 'btn-outline' : 'btn-success'}" onclick="toggleService(${s.id}, ${!s.active})">${s.active ? 'Desativar' : 'Ativar'}</button>
              <button class="btn btn-sm btn-danger" onclick="deleteService(${s.id})" title="Excluir">Excluir</button>
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error(err); }
    }

    function editService(id) {
      const svc = (window.adminServices || []).find(s => s.id === id);
      if (!svc) return;
      document.getElementById('svcId').value = svc.id;
      document.getElementById('svcName').value = svc.name;
      document.getElementById('svcDescription').value = svc.description || '';
      document.getElementById('svcDuration').value = svc.duration || 60;
      document.getElementById('svcIcon').value = svc.icon || 'treatment';
      document.getElementById('svcSubmitBtn').textContent = 'Salvar Altera√ß√µes';
      document.getElementById('svcCancelBtn').style.display = 'inline-block';
      updateSvcIconPreview();
    }

    function resetServiceForm() {
      document.getElementById('svcId').value = '';
      document.getElementById('serviceForm').reset();
      document.getElementById('svcSubmitBtn').textContent = 'Adicionar Servi√ßo';
      document.getElementById('svcCancelBtn').style.display = 'none';
      updateSvcIconPreview();
    }

    async function addService(e) {
      e.preventDefault();
      const id = document.getElementById('svcId').value;
      const name = document.getElementById('svcName').value;
      const description = document.getElementById('svcDescription').value;
      const duration = parseInt(document.getElementById('svcDuration').value);
      const icon = document.getElementById('svcIcon').value;

      try {
        if (id) {
          // update existing
          const res = await fetch(`${API}/services/${id}`, {
            method: 'PATCH',
            headers: apiHeaders(),
            body: JSON.stringify({ name, description, duration, icon })
          });
          if (res.ok) {
            showAdminToast('Servi√ßo atualizado!', 'success');
            resetServiceForm();
            loadServices();
          } else {
            const err = await res.json();
            showAdminToast(err.error || 'Erro', 'error');
          }
        } else {
          // create new
          const res = await fetch(`${API}/services`, {
            method: 'POST',
            headers: apiHeaders(),
            body: JSON.stringify({ name, description, duration, icon })
          });
          if (res.ok) {
            showAdminToast('Servi√ßo adicionado!', 'success');
            document.getElementById('serviceForm').reset();
            loadServices();
          } else {
            const err = await res.json();
            showAdminToast(err.error || 'Erro', 'error');
          }
        }
      } catch (err) { showAdminToast('Erro', 'error'); }
      updateSvcIconPreview();
    }

    async function toggleService(id, active) {
      try {
        await fetch(`${API}/services/${id}`, { method: 'PATCH', headers: apiHeaders(), body: JSON.stringify({ active }) });
        loadServices();
      } catch (err) { showAdminToast('Erro', 'error'); }
    }

    // ========== DELETE SERVICE (Admin) ==========
    async function deleteService(id) {
      if (!confirm('Excluir este servi√ßo? Esta a√ß√£o n√£o pode ser desfeita.')) return;
      try {
        let res = await fetch(`${API}/services/${id}`, { method: 'DELETE', headers: apiHeaders() });
        if (res.ok) {
          showAdminToast('Servi√ßo exclu√≠do', 'success');
          loadServices();
          loadAppointments();
          return;
        }

        // try to parse JSON body; fallback to text
        let body = null;
        try { body = await res.json(); } catch (e) { body = await res.text(); }

        // If server reports linked appointments, offer cascade delete
        if (res.status === 409 && body && body.linked) {
          const cnt = body.linked;
          if (confirm(`Existem ${cnt} agendamento(s) vinculados a este servi√ßo. Deseja excluir o servi√ßo e remover tamb√©m esses agendamentos?`)) {
            const cascadeRes = await fetch(`${API}/services/${id}?cascade=1`, { method: 'DELETE', headers: apiHeaders() });
            if (cascadeRes.ok) {
              showAdminToast('Servi√ßo e agendamentos exclu√≠dos', 'success');
              loadServices();
              loadAppointments();
            } else {
              let cascadeBody = null;
              try { cascadeBody = await cascadeRes.json(); } catch (e) { cascadeBody = await cascadeRes.text(); }
              console.error('cascade delete failed', cascadeRes.status, cascadeBody);
              showAdminToast((cascadeBody && cascadeBody.error) || `Erro ao excluir (status ${cascadeRes.status})`, 'error');
            }
          }
        } else {
          console.error('delete failed', res.status, body);
          showAdminToast((body && body.error) || `Erro ao excluir (status ${res.status})`, 'error');
        }
      } catch (err) { console.error('deleteService error', err); showAdminToast('Erro ao excluir servi√ßo', 'error'); }
    }

    // === service icon preview helper ===
    function updateSvcIconPreview() {
      const sel = document.getElementById('svcIcon');
      const preview = document.getElementById('svcIconPreview');
      if (!sel || !preview) return;
      const key = sel.value || 'treatment';
      preview.innerHTML = ADMIN_ICONS[key] || ADMIN_ICONS['treatment'];
    }
    document.addEventListener('DOMContentLoaded', () => {
      const s = document.getElementById('mapSearch');
      if (s) s.addEventListener('input', debouncedMapSearch);
      const latEl = document.getElementById('mapLat');
      const lngEl = document.getElementById('mapLng');
      const zoomEl = document.getElementById('mapZoom');
      if (latEl) latEl.addEventListener('input', updateMapPreview);
      if (lngEl) lngEl.addEventListener('input', updateMapPreview);
      if (zoomEl) zoomEl.addEventListener('input', updateMapPreview);

      // wire icon preview
      const iconSel = document.getElementById('svcIcon');
      if (iconSel) { iconSel.addEventListener('change', updateSvcIconPreview); updateSvcIconPreview(); }
    });

    // ========== MESSAGES ==========
    async function loadMessages() {
      try {
        const res = await fetch(`${API}/messages`, { headers: apiHeaders() });
        const messages = await res.json();
        const tbody = document.getElementById('messagesTableBody');

        if (messages.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray)">Nenhuma mensagem</td></tr>';
          return;
        }

        tbody.innerHTML = messages.map(m => `
          <tr style="${m.read ? '' : 'font-weight:600;background:var(--nude-light)'}">
            <td>${m.name}</td>
            <td>${m.email || '-'}</td>
            <td>${m.phone || '-'}</td>
            <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.message}</td>
            <td>${formatDateTime(m.created_at)}</td>
            <td>
              ${m.read ? '<span style="color:var(--gray);font-size:0.8rem">Lida</span>' :
                `<button class="btn btn-sm btn-primary" onclick="markRead(${m.id})">Marcar lida</button>`}
            </td>
          </tr>
        `).join('');
      } catch (err) { console.error(err); }
    }

    async function markRead(id) {
      try {
        await fetch(`${API}/messages/${id}`, { method: 'PATCH', headers: apiHeaders() });
        loadMessages();
        loadStats();
      } catch (err) { showAdminToast('Erro', 'error'); }
    }

    // ========== UTILS ==========
    function formatDate(str) {
      if (!str) return '-';
      const [y, m, d] = str.split('-');
      return `${d}/${m}/${y}`;
    }

    function formatDateTime(str) {
      if (!str) return '-';
      const d = new Date(str);
      return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    function statusLabel(s) {
      const labels = { confirmed: 'Confirmado', cancelled: 'Cancelado', completed: 'Conclu√≠do', pending: 'Pendente' };
      return labels[s] || s;
    }

    function showAdminToast(msg, type) {
      const toast = document.createElement('div');
      toast.className = `admin-toast ${type}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
    }

    // ========== VIEW NOTE (modal) ==========
    function viewNote(note) {
      const overlay = document.createElement('div');
      overlay.className = 'admin-modal-overlay';

      const modal = document.createElement('div');
      modal.className = 'admin-modal';

      const h = document.createElement('h4');
      h.textContent = 'Observa√ß√£o';

      const body = document.createElement('div');
      body.className = 'modal-body';
      body.textContent = note || '-';

      const actions = document.createElement('div');
      actions.className = 'modal-actions';
      const closeBtn = document.createElement('button');
      closeBtn.className = 'btn btn-primary';
      closeBtn.textContent = 'Fechar';
      closeBtn.addEventListener('click', () => overlay.remove());
      actions.appendChild(closeBtn);

      modal.appendChild(h);
      modal.appendChild(body);
      modal.appendChild(actions);
      overlay.appendChild(modal);

      overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
      document.addEventListener('keydown', function onEsc(e) { if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', onEsc); } });

      document.body.appendChild(overlay);
    }

    // lookup helper ‚Äî finds appointment in memory and opens modal safely
    function viewNoteById(id) {
      const appts = window.adminAppointments || [];
      const a = appts.find(x => x.id === id);
      if (!a) return viewNote('-');
      viewNote(a.notes || '-');
    }
  </script>
</body>
</html>
